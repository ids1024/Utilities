#!/usr/bin/env python

import os
import subprocess
import time
import alsaaudio
from email.utils import parseaddr
from email.parser import BytesHeaderParser
import abook
import psutil

tmpdir = "/tmp/dwmstatus"
inbox = os.path.expanduser("~/.mail/perebruin/INBOX")

def colorPercent(percent, name):
    percent = round(percent)
    if percent < 20:
        color = None
    elif percent < 50:
        color = "yellow"
    elif percent < 80:
        color = "orange"
    else:
        color = "red"
    return (str(percent) + '% ' + name, color)


def date():
    return time.strftime('%a %b %d %I:%M %p')

def ssid():
    try:
        output = subprocess.check_output(('iw','wlp2s0', 'link')).decode()
    except subprocess.CalledProcessError:
        return
    if 'Not connected.' in output:
        return
    else:
        return output.split('\n')[1].split()[1]

def volume():
    try:
        mixer = alsaaudio.Mixer("Master")
        vol = mixer.getvolume()[0]
        if mixer.getmute()[0]:
            return str(vol) + "% Muted", "grey"
        else:
            return str(vol) + "% Volume"
    except alsaaudio.ALSAAudioError:
        return "? Volume"

def cpu():
    return colorPercent(psutil.cpu_percent(), 'CPU')

def ram():
    return colorPercent(psutil.virtual_memory().percent, 'RAM')

def mail():
    addressbook = abook.get_abook()
    parser = BytesHeaderParser()
    os.chdir(inbox + "/new")
    emails = os.listdir()
    if not emails:
        return
    for i in emails:
        with open(i, 'rb') as file:
            addr = parser.parse(file).get('from')
        if parseaddr(addr)[1] in addressbook:
            return ('M', "red")
    return 'M'

def music():
    cmd = ["playerctl", "metadata", "xesam:title"]
    try:
        output = subprocess.check_output(cmd, stderr=subprocess.DEVNULL).decode()
    except subprocess.CalledProcessError:
        return
    return output

items = (music, volume, cpu, ram, ssid, date)
indicators = (mail,)
divider = ' â˜™ '
